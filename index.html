<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>단어 치환기</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 40px auto; padding: 0 20px; transition: background 0.3s, color 0.3s; }
    body.dark { background: #222; color: #ddd; }
    textarea, input { width: 100%; padding: 10px; margin-bottom: 12px; font-size: 16px; box-sizing: border-box; background: inherit; color: inherit; border: 1px solid #ccc; }
    body.dark textarea, body.dark input { border-color: #555; }
    .pair { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 8px; }
    .pair input { flex: 1 1 40%; min-width: 40%; }
    .pair button { padding: 6px 10px; font-size: 14px; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .copy-btn, .download-btn { position: absolute; top: 5px; right: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; }
    #output, #inputText { white-space: pre-wrap; background: #f9f9f9; font-size: 16px; line-height: 1.5; }
    body.dark #output, body.dark #inputText { background: #333; }
    #output mark { background-color: yellow; font-weight: bold; }
    .move-btn { background: #eef; border: 1px solid #88f; color: #004; }
    .delete-btn { background: #ffdddd; border: 1px solid #ff9999; color: #a00; }
    @media screen and (max-width: 500px) { .pair input { min-width:100%; flex:1 1 100%; } }
  </style>
</head>
<body>
  <h1>🔄 단어 치환기</h1>
  <button onclick="toggleDarkMode()">🌗 다크모드 전환</button>

  <h3>① 문장 입력</h3>
  <div style="position:relative;">
    <textarea id="inputText" rows="5" placeholder="문장을 입력하세요."></textarea>
    <button class="copy-btn" onclick="copyText('inputText')">복사</button>
  </div>

  <h3>② 단어쌍 관리 (총 <span id="pairCount">0</span>개)</h3>
  <input type="file" id="csvUpload" accept=".csv">
  <div id="wordPairs"></div>

  <div class="controls">
    <button onclick="addPair()">+ 단어쌍 추가</button>
    <button onclick="replaceWords()">🔄 변환</button>
    <button class="download-btn" onclick="downloadCSV()">📤 CSV 저장</button>
  </div>

  <h3>③ 변환된 문장</h3>
  <div style="position:relative;">
    <div id="output" style="min-height:100px; border:1px solid #ddd; padding:10px;"></div>
    <button class="copy-btn" onclick="copyText('output')">복사</button>
  </div>

  <!-- PapaParse CDN -->
  <script src="https://cdn.jsdelivr.net/npm/[email protected]/papaparse.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      addPair(); addPair();
      document.getElementById('csvUpload').addEventListener('change', handleCsvUpload);
      updateCount();
    });

    function toggleDarkMode() {
      document.body.classList.toggle('dark');
    }

    function addPair(from='', to='') {
      const pair = document.createElement('div');
      pair.className = 'pair';
      pair.innerHTML = `
        <input class="from" placeholder="원본 단어" value="${from}">
        <input class="to" placeholder="수정 단어" value="${to}">
        <button class="move-btn" onclick="moveUp(this)">↑</button>
        <button class="move-btn" onclick="moveDown(this)">↓</button>
        <button class="delete-btn" onclick="deletePair(this)">❌</button>
      `;
      document.getElementById('wordPairs').appendChild(pair);
      pair.querySelectorAll('input').forEach(el => el.addEventListener('input', updateCount));
      updateCount();
    }

    function deletePair(btn) {
      btn.parentElement.remove();
      updateCount();
    }

    function moveUp(btn) {
      const cur = btn.parentElement, prev = cur.previousElementSibling;
      if (prev) cur.parentNode.insertBefore(cur, prev);
    }

    function moveDown(btn) {
      const cur = btn.parentElement, nxt = cur.nextElementSibling;
      if (nxt) cur.parentNode.insertBefore(nxt, cur);
    }

    function replaceWords() {
      let text = inputText.value;
      let disp = text;
      document.querySelectorAll('.pair').forEach(pair => {
        const from = pair.querySelector('.from').value.trim();
        const to = pair.querySelector('.to').value.trim();
        if (from) {
          const regex = new RegExp(from, 'gi');
          disp = disp.replace(regex, match => `<mark>${to}</mark>`);
        }
      });
      output.innerHTML = disp;
    }

    function copyText(id) {
      const el = document.getElementById(id);
      navigator.clipboard.writeText(el.value || el.innerText).then(() => {
        alert('복사되었습니다!');
      });
    }

    function updateCount() {
      document.getElementById('pairCount').innerText = document.querySelectorAll('.pair').length;
    }

    function downloadCSV() {
      const rows = Array.from(document.querySelectorAll('.pair'))
        .map(p => {
          const f = p.querySelector('.from').value;
          const t = p.querySelector('.to').value;
          return `"${f}","${t}"`;
        }).join('\n');
      const BOM = '\uFEFF'; // 한글 깨짐 방지
      const blob = new Blob([BOM + rows], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = '단어쌍.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    function handleCsvUpload(e) {
      const file = e.target.files[0];
      if (!file) return;

      Papa.parse(file, {
        skipEmptyLines: true,
        complete: ({ data }) => {
          document.getElementById('wordPairs').innerHTML = ''; // 초기화

          data.forEach(row => {
            if (Array.isArray(row) && row.length >= 2) {
              let from = row[0]?.trim().replace(/^"|"$/g, '');
              let to = row[1]?.trim().replace(/^"|"$/g, '');
              if (from && to) addPair(from, to);
            }
          });

          updateCount();
          replaceWords(); // 자동 반영
        }
      });
    }
  </script>
</body>
</html>
